---
title: "Untitled"
author: "RN7"
date: "9/13/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Packages 

```{r message=FALSE}
pacman::p_load(
  dplyr, tidyr, purrr, readr,
  stringr, tibble,
  glue, extrafont,
  ggplot2, magick,
  cowplot, patchwork,
  ggforce,
  rvest, polite,
  googledrive
)

extrafont::loadfonts()
```


* Team Totals
* Team by Game
* Player Totals
* Player by Game



# Data


```{r}

options(googledrive_quiet = TRUE)
googledrive::drive_auth(path = "~/.R/gargle/indigo-bazaar-325705-4c1134b651dc.json")

data_folder <- drive_ls(path = "Centre Circle Data & Info")

data_csv <- data_folder %>% filter(str_detect(name, ".csv")) %>% arrange(name)

# drive_find()
# drive_ls()
# 
# cpl2019_pbg <- drive_get(id = "1CS3aJ3LDjgw8Zi2myj3oE2Bvuikvuyeg")
# cpl2019_pbg <- drive_read_raw(file = as_id("1CS3aJ3LDjgw8Zi2myj3oE2Bvuikvuyeg"), type = "csv")

data_path <- here::here("data/CanPL_data")

#drive_download(file = data_csv[1,], path = paste(data_path, ))

data_name <- data_csv[1,][1]

#drive_download(file = as_id("1CS3aJ3LDjgw8Zi2myj3oE2Bvuikvuyeg"), path = paste0(data_path, "/", data_name))





data_csv$name
data_csv$id

# g_id <- "1CS3aJ3LDjgw8Zi2myj3oE2Bvuikvuyeg"
# data_name <- "CPLPlayerByGame2019.csv"


get_Drive_CPL_data <- function(g_id, data_name) {
  cat("... Trying to download", data_name, "...")
  
  safe_drive_download <- purrr::safely(drive_download)
  dl_return <- safe_drive_download(file = as_id(g_id), path = paste0(data_path, "/", data_name), overwrite = TRUE)
  
  if (is.null(dl_return$result)) {
    cat("\nSomething went wrong!\n")
  } else {
    res <- dl_return$result
    cat("\nFile:", res$name, "download successful!", "\nPath:", res$local_path, "\n")
  }
}

## Download all files from Google Drive!
map2(data_csv$id, data_csv$name,
     ~ get_Drive_CPL_data(g_id = .x, data_name = .y))

beepr::beep(8)

```


do via data_csv? Then can just add final path to local when successful. Even if fail, original should remain...?


- carve them up and upload them into thematic individual tables in a DB?
- create reports via RMD
- create Shiny app
- create Twitter bot


# Github Actions








```{r}
data_csv

data_path
```














# Misc


```{r}
CPL_playerTotal_2020 <- readr::read_csv(file = here::here("data/CPLPlayerTotals2020.csv"))
CPL_teamTotal_2020 <- readr::read_csv(file = here::here("data/CPLTeamTotals2020.csv"))
CPL_playerPG_2020 <- readr::read_csv(file = here::here("data/CPLPlayerByGame2020.csv"))
CPL_teamPG_2020 <- readr::read_csv(file = here::here("data/CPLTeamByGame2020.csv"))


CPL_playerTotal_2021 <- readr::read_csv(file = here::here("data/CPLPlayerTotals2021.csv"))
CPL_teamTotal_2021 <- readr::read_csv(file = here::here("data/CPLTeamTotals2021.csv"))
CPL_playerPG_2021 <- readr::read_csv(file = here::here("data/CPLPlayerByGame2021.csv"))
CPL_teamPG_2021 <- readr::read_csv(file = here::here("data/CPLTeamByGame2021.csv"))
```

```{r}
glimpse(CPL_teamTotal_2020)
```






```{r}
CPL_teamTotal_2021 %>% 
  select(ShotsTotal, xGPerShot, GM, Team, NonPenxG, PenTaken) %>% 
  mutate(NonPenShotsTotal = ShotsTotal - PenTaken,
         NonPenXGPerShot = NonPenxG / NonPenShotsTotal,
         NonPenShotsP90 = NonPenShotsTotal / (GM * 90) * 90,
         NonPenxGP90 = NonPenxG / (GM * 90) * 90)
```




- need to do work to flip everything and re-combine to get "against_" stats....





# League table

```{r}
library(gt)
```


```{r}
cpl_team_total_2021 <- read.csv(file = "data/CPLTeamTotals2021.csv")

glimpse(cpl_team_total_2021)
```

```{r}
cpl_team_pergame_2021 <- read.csv(file = here::here("data/CPLTeamByGame2021.csv"))

glimpse(cpl_team_pergame_2021)

cpl_team_pergame_2021 %>% select(sort(current_vars())) %>% glimpse()
```
`.1` are duplicates...


```{r}
row1 <- cpl_team_pergame_2021 %>% slice_head(n = 2)

row1 %>% select(teamFullName, teamAbbrevName, opponentFullName, Win, Draw, Loss, Home, Away, Week, Result, GM, Date, Week) 
```

GM and Week are useless... number games by order of `Date`

```{r}
rowED <- cpl_team_pergame_2021 %>% filter(teamFullName == "Edmonton")

rowED %>% select(teamFullName, teamAbbrevName, opponentFullName, Win, Draw, Loss, Home, Away, Result, Date) 
```


- group by gameId
- two rows per each game --- home and away team
- change column names to `home_*` and `away_*`
- combine into one row per game
- figure out for vs. against stats from that configuration of data




```{r}
game1 <- cpl_team_pergame_2021 %>% 
  filter(gameId == "18o1gqawfartt7bvr61uhr40k") %>% 
  select(teamFullName, ExpG, ExpA, PassesIntoBox, Home, Away, gameId)
```


```{r}
game1 %>% 
  #group_by(gameId) %>% 
  mutate(rid = row_number(),
         home_team = case_when(
           Home == "true" ~ teamFullName,
           TRUE ~ NA_character_
         ),
         away_team = case_when(
           Away == "true" ~ teamFullName,
           TRUE ~ NA_character_
         )) %>% 
  select(-teamFullName) %>% 
  ## set everything as character while we combine, BE CAREFUL how you handle the data in future steps
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = ExpG:gameId) %>% 
  unite(column_name, name, rid, sep = "--") %>% 
  unite(column_name, column_name, home_team, away_team, sep = "--", remove = FALSE) %>% 
  pivot_wider(names_from = column_name, values_from = value) %>% View()
```

https://stackoverflow.com/questions/41260102/merging-multiple-rows-into-single-row

```{r}
game1 %>% 
  #group_by(gameId) %>% 
  mutate(rid = row_number(),
         home_team = case_when(
           Home == "true" ~ teamFullName,
           TRUE ~ NA_character_
         ),
         away_team = case_when(
           Away == "true" ~ teamFullName,
           TRUE ~ NA_character_
         ),
         Home = case_when(
           Home == "true" ~ "Home",
           TRUE ~ NA_character_
         ),
         Away = case_when(
           Away == "true" ~ "Away",
           TRUE ~ NA_character_
         )) %>% 
  #select(-teamFullName) %>% 
  ## set everything as character while we combine, BE CAREFUL how you handle the data in future steps
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = -c(rid, home_team, away_team)) %>% 
  unite(column_name, name, rid, home_team, away_team, sep = "--") %>% 
  #unite(column_name, column_name, home_team, away_team, sep = "--", remove = FALSE) %>% 
  pivot_wider(names_from = column_name, values_from = value) %>% View()
```



```{r}
cpl_team_pergame_2021 %>% 
  select(contains("Id", ignore.case = FALSE)) %>% 
  names()
```



```{r}
game1 %>% 
  #group_by(gameId) %>% 
  mutate(rid = row_number(),
         home_team = case_when(
           Home == "true" ~ teamFullName,
           TRUE ~ NA_character_
         ),
         away_team = case_when(
           Away == "true" ~ teamFullName,
           TRUE ~ NA_character_
         ),
         Home = case_when(
           Home == "true" ~ "Home",
           TRUE ~ NA_character_
         ),
         Away = case_when(
           Away == "true" ~ "Away",
           TRUE ~ NA_character_
         )) %>% 
  ## set everything as character while we combine, BE CAREFUL how you handle the data in future steps
  mutate(across(everything(), as.character)) %>% 
  pivot_longer(cols = -c(rid, Home, Away)) %>% 
  unite(column_name, name, rid, Home, Away, sep = "--") %>% 
  #unite(column_name, column_name, home_team, away_team, sep = "--", remove = FALSE) %>% 
  pivot_wider(names_from = column_name, values_from = value) %>% View()
```





```{r}
## DONE
game1 %>% 
  #group_by(gameId) %>% 
  mutate(#rid = row_number(),
         home_team = case_when(
           Home == "true" ~ teamFullName,
           TRUE ~ NA_character_
         ),
         away_team = case_when(
           Away == "true" ~ teamFullName,
           TRUE ~ NA_character_
         ),
         Home = case_when(
           Home == "true" ~ "Home",
           TRUE ~ NA_character_
         ),
         Away = case_when(
           Away == "true" ~ "Away",
           TRUE ~ NA_character_
         )) %>% 
  ## set everything as character while we combine, BE CAREFUL how you handle the data in future steps
  mutate(across(everything(), as.character)) %>% 
  ## pivot and then unite so column names are appended with home or away: xG_home, xG_away, etc.
  pivot_longer(cols = -c(Home, Away)) %>% 
  unite(column_name, name, Home, Away, sep = "--") %>% 
  ## clean-up the column names
  mutate(column_name = str_squish(column_name),
         column_name = str_replace_all(column_name, "--NA--", "--"),
         column_name = str_replace_all(column_name, "--NA", "")) %>% 
  filter(!column_name %in% c("away_team--Home", "home_team--Away")) %>% 
  ## we only ever need 1 col for each of the "Id" vars
  arrange(column_name) %>% 
  #unite(column_name, column_name, home_team, away_team, sep = "--", remove = FALSE) %>% 
  pivot_wider(names_from = column_name, values_from = value) %>% View()
```


- attempt ALL games , grouping?

GROUP AND NEST?


```{r}
cpl_team_pergame_2021 %>% 
  #group_by(gameId) %>% 
  mutate(#rid = row_number(),
         home_team = case_when(
           Home == "true" ~ teamFullName,
           TRUE ~ NA_character_
         ),
         away_team = case_when(
           Away == "true" ~ teamFullName,
           TRUE ~ NA_character_
         ),
         Home = case_when(
           Home == "true" ~ "Home",
           TRUE ~ NA_character_
         ),
         Away = case_when(
           Away == "true" ~ "Away",
           TRUE ~ NA_character_
         )) %>% 
  ## set everything as character while we combine, BE CAREFUL how you handle the data in future steps
  mutate(across(everything(), as.character)) %>% 
  ## pivot and then unite so column names are appended with home or away: xG_home, xG_away, etc.
  pivot_longer(cols = -c(Home, Away, -gameId)) %>% 
  unite(column_name, name, Home, Away, sep = "--") %>% 
  ## clean-up the column names
  mutate(column_name = str_squish(column_name),
         column_name = str_replace_all(column_name, "--NA--", "--"),
         column_name = str_replace_all(column_name, "--NA", "")) %>% 
  filter(!column_name %in% c("away_team--Home", "home_team--Away")) %>% 
  ## we only ever need 1 col for each of the "Id" vars
  arrange(column_name) %>% 
  #unite(column_name, column_name, home_team, away_team, sep = "--", remove = FALSE) %>% 
  pivot_wider(names_from = column_name, values_from = value) %>% View()
```







```{r}
elongate_per_game <- function(data) {
  elon_df <- data %>% 
      mutate(#rid = row_number(),
         home_team = case_when(
           Home == "true" ~ teamFullName,
           TRUE ~ NA_character_
         ),
         away_team = case_when(
           Away == "true" ~ teamFullName,
           TRUE ~ NA_character_
         ),
         Home = case_when(
           Home == "true" ~ "Home",
           TRUE ~ NA_character_
         ),
         Away = case_when(
           Away == "true" ~ "Away",
           TRUE ~ NA_character_
         )) %>% 
  ## set everything as character while we combine, BE CAREFUL how you handle the data in future steps
  mutate(across(everything(), as.character)) %>% 
  ## pivot and then unite so column names are appended with home or away: xG_home, xG_away, etc.
  pivot_longer(cols = -c(Home, Away)) %>% 
  unite(column_name, name, Home, Away, sep = "--") %>% 
  ## clean-up the column names
  mutate(column_name = str_squish(column_name),
         column_name = str_replace_all(column_name, "--NA--", "--"),
         column_name = str_replace_all(column_name, "--NA", "")) %>% 
  filter(!column_name %in% c("away_team--Home", "home_team--Away")) %>% 
  ## we only ever need 1 col for each of the "Id" vars
  arrange(column_name) %>% 
  #unite(column_name, column_name, home_team, away_team, sep = "--", remove = FALSE) %>% 
  pivot_wider(names_from = column_name, values_from = value)
  
  return(elon_df)
}
```


```{r}
cpl_permatch <- cpl_team_pergame_2021 %>% 
  group_by(gameId) %>% 
  nest() %>% 
  mutate(data2 = map(data, ~ elongate_per_game(data = .x))) %>% 
  ungroup()

```

```{r}
cpl_permatch[[3]][[1]] %>% arrange() %>% View()
```

```{r}
cpl_permatch_df <- cpl_permatch %>% 
  select(-data) %>% 
  unnest(cols = c(data2))
```


take out the SINGLE value cols, then join them back in using the `gameId` after done with the nesting and spreading




thenfrom each col_name, get rid of "NA" and "gameId"

could just re-add gameId based on the home-away team names? separately?



```{r}
edmonton_all <- cpl_permatch_df %>% 
  filter(`teamFullName--Home` == "Edmonton" | `teamFullName--Away` == "Edmonton") %>% 
  select(`teamFullName--Away`, `teamFullName--Home`, `Goal--Home`, `Goal--Away`, contains("NonPenxG")) %>% 
  mutate(
    team = "Edmonton",
    opponent = case_when(
      `teamFullName--Home` == "Edmonton" ~ `teamFullName--Away`,
      `teamFullName--Away` == "Edmonton" ~ `teamFullName--Home`,
      TRUE ~ NA_character_
    ),
    goal = case_when(
      `teamFullName--Home` == "Edmonton" ~ `Goal--Home`,
      `teamFullName--Away` == "Edmonton" ~ `Goal--Away`,
    ),
    goalAgainst = case_when(
      `teamFullName--Home` == "Edmonton" ~ `Goal--Away`,
      `teamFullName--Away` == "Edmonton" ~ `Goal--Home`,
    ),
    xG = case_when(
      `teamFullName--Home` == "Edmonton" ~ `NonPenxG--Home`,
      `teamFullName--Away` == "Edmonton" ~ `NonPenxG--Away`,
    ),
    xGA = case_when(
      `teamFullName--Home` == "Edmonton" ~ `NonPenxG--Away`,
      `teamFullName--Away` == "Edmonton" ~ `NonPenxG--Home`,
    )) %>% 
  select(-contains("--"))

edmonton_all
```



```{r}
edmonton_all %>% 
  mutate(across(-c(team, opponent), as.numeric)) %>% 
  summarize(
    tot_goal = sum(goal),
    tot_goalAgainst = sum(goalAgainst),
    tot_xG = sum(xG),
    tot_xGA = sum(xGA),
    team = unique(team)
  )
```


iterate over ALL teams, combine and create league table








